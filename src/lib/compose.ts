/**
 * Docker Compose file generation
 */

import { dirname, join } from "node:path";
import { existsSync, mkdirSync, readFileSync, writeFileSync } from "node:fs";
import { fileURLToPath } from "node:url";
import chalk from "chalk";
import type { ConfigPaths, InfraConfig } from "./config.js";
import { DEFAULTS } from "./config.js";

const __dirname = dirname(fileURLToPath(import.meta.url));
const ENTRYPOINT_SOURCE = join(__dirname, "..", "..", "templates", "entrypoint.ts");
const ENTRYPOINT_LOCAL = ".polyclaw/entrypoint.ts";

/**
 * Ensure entrypoint.ts is copied to the project directory
 */
function ensureEntrypoint(baseDir: string): void {
  const localDir = join(baseDir, ".polyclaw");
  const localPath = join(baseDir, ENTRYPOINT_LOCAL);

  if (!existsSync(localDir)) {
    mkdirSync(localDir, { recursive: true });
  }

  // Always copy to ensure it's up to date
  const content = readFileSync(ENTRYPOINT_SOURCE, "utf-8");
  writeFileSync(localPath, content);
}

/**
 * Read .env file and extract variable names
 */
function getEnvVarNames(baseDir: string): string[] {
  const envPath = join(baseDir, ".env");
  if (!existsSync(envPath)) {
    return [];
  }

  const content = readFileSync(envPath, "utf-8");
  const varNames: string[] = [];

  for (const line of content.split("\n")) {
    const trimmed = line.trim();
    // Skip comments and empty lines
    if (!trimmed || trimmed.startsWith("#")) continue;

    // Extract variable name (before the =)
    const match = trimmed.match(/^([A-Z_][A-Z0-9_]*)=/);
    if (match) {
      varNames.push(match[1]);
    }
  }

  return varNames;
}

/**
 * Generate docker-compose.yml content from configuration
 */
export function generateComposeContent(
  config: InfraConfig,
  baseDir: string
): string {
  const project = config.project;
  const image = config.docker?.image || DEFAULTS.image;

  // Keep skills path relative if it starts with ./
  const skillsPath = config.docker?.skills_path || null;

  // Ensure entrypoint is copied to project
  ensureEntrypoint(baseDir);

  let compose = `# Generated by polyclaw
# Do not edit manually - edit polyclaw.json5 and regenerate

name: ${project}

services:
`;

  // Get env vars from .env file
  const envVars = getEnvVarNames(baseDir);
  const envLines = envVars.map((v) => `      ${v}: \${${v}}`).join("\n");

  for (const [name, inst] of Object.entries(config.instances)) {
    const skillsVolume = skillsPath
      ? `\n      - ${skillsPath}:/skills-custom:ro`
      : "";

    const entrypointVolume = `./${ENTRYPOINT_LOCAL}:/app/entrypoint.ts:ro`;

    // Combine global volumes + instance-specific volumes
    const globalVolumes = config.docker?.volumes || [];
    const instanceVolumes = inst.volumes || [];
    const allVolumes = [...globalVolumes, ...instanceVolumes];

    const extraVolumes = allVolumes
      .map((v) => {
        const mode = v.mode || "rw";
        return `\n      - "${v.host}:${v.container}:${mode}"`;
      })
      .join("");

    compose += `  ${name}:
    image: ${image}
    container_name: ${project}-${name}
    environment:
      HOME: /home/node
${envLines}
    volumes:
      - ./instances/${name}/config:/home/node/.openclaw
      - ./instances/${name}/workspace:/home/node/.openclaw/workspace${skillsVolume}${extraVolumes}
      - ${entrypointVolume}
    ports:
      - "${inst.port}:18789"
    entrypoint: ["node", "--experimental-strip-types", "/app/entrypoint.ts"]
    command: ["--bind", "lan"]
    restart: unless-stopped

`;
  }

  return compose;
}

/**
 * Generate and write docker-compose.yml file
 */
export function generateComposeFile(
  config: InfraConfig,
  paths: ConfigPaths
): void {
  console.log(chalk.green("=== Generating docker-compose.yml ==="));

  const content = generateComposeContent(config, paths.baseDir);
  writeFileSync(paths.composeFile, content);

  const count = Object.keys(config.instances).length;
  console.log(
    `  ${chalk.green("OK")} docker-compose.yml generated with ${count} service(s)`
  );
}
